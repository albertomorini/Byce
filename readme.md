# Byce
##### A battery logger by Alberto Morini (mat. 141986)

This app is my project for IOT (Internet Of Things) course at University of Udine.

## What's is it?
Byce is an application created with <u url="https://cordova.apache.org/">Cordova</u> (by Apache).
The app will get the battery level of the devices where is installed, and next send the info to a local server which shows the data and a storyboard of the battery of each devices.

#### Utility
You can get the battery level and if the devices are charging whenever the battery percentage change.
>Imagine a restaurant with +40 tablets used to see the menu and order the food, at the end of the day a waiter need to check all of them to see which one needs to be put in charge .. With this solution the waiter can check the status of all the devices in few seconds.


## Depencencies:
1. NodeJS and NPM
2. Cordova (installable with npm -> `$ sudo npm install -g cordova`)
    * cordova-plugin-battery-status -> get battery info
    * cordova-plugin-device-name -> get the device's name
    * cordova-plugin-background-mode -> keep the app running in background
    * cordova-plugin-advanced-http -> send a POST request via http

3. For android development
    * Android studio `$ sudo snap install android-studio --classic` / Android SDK
    * Gradle `$ sudo apt-get install gradle`
    * A virtual device (which need to be on), installable via Android Studio

    > run `$ cordova requirements` to check if you got everything you need to proceed.. Probably, Cordova will ask you a specific version of Android SDK (eg. platform;sdk-30).
    Follow this guide: https://ionicframework.com/docs/developing/android#installing-the-android-sdk
    Tips: Select Android SDK, next, in the bottom right of the pop-up window select "Show package details"

    >Follow this guide in way to configure Android SDK in your Command Line Tools: https://ionicframework.com/docs/developing/android#configuring-command-line-tools


## The database
1. install mysql -> `$ sudo apt install mysql-server`
2. get into -> `$ mysql -h localhost -P 3306 -u root -p`
3. create a user (pick a strong password, mysql has some requirements)
```sql
CREATE USER 'username'@'localhost' IDENTIFIED BY 'YourPsw';
GRANT ALL PRIVILEGES ON *.* TO 'alby'@'localhost' WITH GRANT OPTION;
```
or change the password of the root user
```sql
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'YourPsw'
```
4. create the database
```sql
CREATE DATABASE byce;
CONNECT byce;
```
5. create the table 'Dataset'
```sql
create table Dataset(
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    battery INTEGER NOT NULL,
    incharge BOOLEAN NOT NULL,
    name VARCHAR(256) NOT NULL,
    data DATE NOT NULL,
    tempo TIME NOT NULL
);
SHOW SCHEMAS;
```

Once created the database, we have to connect it with ours server.
1. go to server/server.js
2. install the module mysql `$ npm install mysql`
3. create the connection
```javascript  
var mysql = require('mysql');
var con = mysql.createConnection({
        host: "localhost",
        user: "root",
        password: "YourPsw",    
        database: "byce"
});
con.connect(function(err) {
        if (err) throw err;
        console.log("Connected!");

        var sql = "INSERT INTO Dataset (battery, incharge, name, data, tempo) VALUES (64,true,'AlbyAndroid','2022/03/08','12:34');"

        con.query(sql, function (err, result) {
            if (err) throw err;
            console.log("1 record inserted");
        });
});
```

## Architecture
The app retrive all the informations needed:
1. battery level and if the device's charging
2. the device's name (eg. AlbysAndroid, TabletA2, SamsungS20 etc.)

then every time the battery level change, a POST request will be sent to the server; the POST request contain the data retrieved and a timestamp generated by client before sending the message.

The body of the request has a content/type=JSON, otherwise the request would be a string (and we will loose all the benefits of a JSON format).

In the javascript of the Cordova app, before send the request we need to add: `   cordova.plugin.http.setDataSerializer('json');` in way to set the content/type.


An example of the package sent:
```JSON
{
  "batteryLevel": 33,
  "inCharge": "false",
  "name": "AlbyAndroid",
  "date": "2022/2/8",
  "time": "15:41"
}
```




## Problems


## Docs used:

* https://twiserandom.com/cordova/getting-battery-status-using-cordova/index.html
* https://www.npmjs.com/package/cordova-plugin-device-name
* https://stackoverflow.com/questions/45940861/android-8-cleartext-http-traffic-not-permitted
* https://www.npmjs.com/package/cordova-plugin-background-mode-fixed
* https://www.w3schools.com/js/js_date_methods.asp


## Grafana
sudo systemctl restart grafana-server
10.0.0.3:3000
admin/F*23
## MySql
10.0.0.3:3306
root/F*23!!


## query

--ULTIMO LIVELLO DI OGNI DISPOSITIVO
SELECT DISTINCT battery,incharge,name,tempo FROM Dataset d1 WHERE NOT EXISTS (SELECT * FROM Dataset d2 WHERE d2.tempo > d1.tempo AND d2.name = d1.name AND NOT EXISTS (SELECT * FROM Dataset d3 WHERE d3.data > d2.data AND d2.name = d3.name ));

+---------+----------+-------------+----------+
| battery | incharge | name        | tempo    |
+---------+----------+-------------+----------+
|      13 |        0 | AlbyAndroid | 19:38:00 |
|      32 |        1 | Device2     | 18:34:00 |
+---------+----------+-------------+----------+

per uno singolo invece:
SELECT DISTINCT battery,incharge,name,tempo FROM Dataset d1 WHERE NOT EXISTS (SELECT * FROM Dataset d2 WHERE d2.tempo > d1.tempo AND AND NOT EXISTS (SELECT * FROM Dataset d3 WHERE d3.data > d2.data AND d3.name = "name" ))
